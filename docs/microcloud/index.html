
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
      
        <link rel="canonical" href="https://santisbon.github.io/reference/microcloud/">
      
      
      
      
      <link rel="icon" href="../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.5.3, mkdocs-material-9.4.14">
    
    
      
        <title>Cloud-native Homelab - Notes</title>
      
    
    
      <link rel="stylesheet" href="../assets/stylesheets/main.fad675c6.min.css">
      
        
        <link rel="stylesheet" href="../assets/stylesheets/palette.356b1318.min.css">
      
      


    
    
      
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
    <script>__md_scope=new URL("..",location),__md_hash=e=>[...e].reduce((e,_)=>(e<<5)-e+_.charCodeAt(0),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
    
  </head>
  
  
    
    
      
    
    
    
    
    <body dir="ltr" data-md-color-scheme="default" data-md-color-primary="indigo" data-md-color-accent="indigo">
  
    
    
      <script>var palette=__md_get("__palette");if(palette&&"object"==typeof palette.color)for(var key of Object.keys(palette.color))document.body.setAttribute("data-md-color-"+key,palette.color[key])</script>
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#cloud-native-homelab" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

  

<header class="md-header md-header--shadow" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href=".." title="Notes" class="md-header__button md-logo" aria-label="Notes" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54Z"/></svg>

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2Z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            Notes
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              Cloud-native Homelab
            
          </span>
        </div>
      </div>
    </div>
    
      
        <form class="md-header__option" data-md-component="palette">
  
    
    
    
    <input class="md-option" data-md-color-media="(prefers-color-scheme: light)" data-md-color-scheme="default" data-md-color-primary="indigo" data-md-color-accent="indigo"  aria-label="Switch to dark mode"  type="radio" name="__palette" id="__palette_1">
    
      <label class="md-header__button md-icon" title="Switch to dark mode" for="__palette_2" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 18a6 6 0 0 1-6-6 6 6 0 0 1 6-6 6 6 0 0 1 6 6 6 6 0 0 1-6 6m8-2.69L23.31 12 20 8.69V4h-4.69L12 .69 8.69 4H4v4.69L.69 12 4 15.31V20h4.69L12 23.31 15.31 20H20v-4.69Z"/></svg>
      </label>
    
  
    
    
    
    <input class="md-option" data-md-color-media="(prefers-color-scheme: dark)" data-md-color-scheme="slate" data-md-color-primary="indigo" data-md-color-accent="indigo"  aria-label="Switch to light mode"  type="radio" name="__palette" id="__palette_2">
    
      <label class="md-header__button md-icon" title="Switch to light mode" for="__palette_1" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9 2c-1.05 0-2.05.16-3 .46 4.06 1.27 7 5.04 7 9.54 0 4.5-2.94 8.27-7 9.54.95.3 1.95.46 3 .46a10 10 0 0 0 10-10A10 10 0 0 0 9 2Z"/></svg>
      </label>
    
  
</form>
      
    
    
    
      <label class="md-header__button md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg>
      </label>
      <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg>
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12Z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
        <button type="reset" class="md-search__icon md-icon" title="Clear" aria-label="Clear" tabindex="-1">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41Z"/></svg>
        </button>
      </nav>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list" role="presentation"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
    
    
      <div class="md-header__source">
        <a href="https://github.com/santisbon/reference" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.4.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2023 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81z"/></svg>
  </div>
  <div class="md-source__repository">
    GitHub
  </div>
</a>
      </div>
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    



<nav class="md-nav md-nav--primary" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href=".." title="Notes" class="md-nav__button md-logo" aria-label="Notes" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54Z"/></svg>

    </a>
    Notes
  </label>
  
    <div class="md-nav__source">
      <a href="https://github.com/santisbon/reference" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.4.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2023 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81z"/></svg>
  </div>
  <div class="md-source__repository">
    GitHub
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
  
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_1" >
        
          
          <label class="md-nav__link" for="__nav_1" id="__nav_1_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    Homelab
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_1_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_1">
            <span class="md-nav__icon md-icon"></span>
            Homelab
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../docker/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Docker
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../k8s/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Kubernetes
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../rpi/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Raspberry Pi
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../k3s/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    K3s
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../rook-ceph/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Rook Ceph
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../microk8s/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    MicroK8s
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../microceph/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    MicroCeph
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_2" >
        
          
          <label class="md-nav__link" for="__nav_2" id="__nav_2_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    New dev machine
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_2_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_2">
            <span class="md-nav__icon md-icon"></span>
            New dev machine
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../install-os/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Install the OS
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../automated/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Automated setup
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../vm/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Virtualization
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../package-mgmt/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Package Manager
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../shell/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Shell
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../utilities/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Utilities
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../editor/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Code Editor
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../git/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Git
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../python/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Python
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../aws/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    AWS
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../mysql/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    MySQL
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../node/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Node
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../mkdocs/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    MkDocs
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#background" class="md-nav__link">
    <span class="md-ellipsis">
      Background
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Background">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#compute" class="md-nav__link">
    <span class="md-ellipsis">
      Compute
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#storage" class="md-nav__link">
    <span class="md-ellipsis">
      Storage
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Storage">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#storage-pools" class="md-nav__link">
    <span class="md-ellipsis">
      Storage Pools
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#storage-volumes" class="md-nav__link">
    <span class="md-ellipsis">
      Storage Volumes
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#storage-buckets" class="md-nav__link">
    <span class="md-ellipsis">
      Storage Buckets
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#networking" class="md-nav__link">
    <span class="md-ellipsis">
      Networking
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Networking">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#managed-networks" class="md-nav__link">
    <span class="md-ellipsis">
      Managed Networks
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Managed Networks">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#fully-controlled-networks" class="md-nav__link">
    <span class="md-ellipsis">
      Fully controlled networks
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#external-networks" class="md-nav__link">
    <span class="md-ellipsis">
      External networks
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#network-devices-nics" class="md-nav__link">
    <span class="md-ellipsis">
      Network devices (NICs)
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#our-hardware" class="md-nav__link">
    <span class="md-ellipsis">
      Our hardware
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#pi-cluster-setup" class="md-nav__link">
    <span class="md-ellipsis">
      Pi Cluster Setup
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#microcloud" class="md-nav__link">
    <span class="md-ellipsis">
      MicroCloud
    </span>
  </a>
  
    <nav class="md-nav" aria-label="MicroCloud">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#install-lxd" class="md-nav__link">
    <span class="md-ellipsis">
      Install LXD
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#provide-storage-disks" class="md-nav__link">
    <span class="md-ellipsis">
      Provide storage disks
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#create-external-network" class="md-nav__link">
    <span class="md-ellipsis">
      Create external network
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#create-cluster-members" class="md-nav__link">
    <span class="md-ellipsis">
      Create cluster members
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Create cluster members">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#create-the-vms" class="md-nav__link">
    <span class="md-ellipsis">
      Create the VMs
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#attach-the-disks-to-the-vms" class="md-nav__link">
    <span class="md-ellipsis">
      Attach the disks to the VMs
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#add-instance-devices" class="md-nav__link">
    <span class="md-ellipsis">
      Add instance devices
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#start-the-vms" class="md-nav__link">
    <span class="md-ellipsis">
      Start the VMs
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#appendix" class="md-nav__link">
    <span class="md-ellipsis">
      APPENDIX
    </span>
  </a>
  
    <nav class="md-nav" aria-label="APPENDIX">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#getting-os-images" class="md-nav__link">
    <span class="md-ellipsis">
      Getting OS images
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#flashing-os-images" class="md-nav__link">
    <span class="md-ellipsis">
      Flashing OS images
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#accessing-a-pi" class="md-nav__link">
    <span class="md-ellipsis">
      Accessing a Pi
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#verifying-correctness" class="md-nav__link">
    <span class="md-ellipsis">
      Verifying correctness
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#troubleshooting" class="md-nav__link">
    <span class="md-ellipsis">
      Troubleshooting
    </span>
  </a>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          
            <div class="md-content" data-md-component="content">
              <article class="md-content__inner md-typeset">
                
                  

  
  


<h1 id="cloud-native-homelab">Cloud-native Homelab<a class="headerlink" href="#cloud-native-homelab" title="Permanent link">#</a></h1>
<p>A homelab is a playground for learning, experimenting, and running workloads in a private environment at home. You can use it to deploy web servers, storage/backup solutions, media servers, home automation, development/test environments, and more.</p>
<p>Building a homelab in a cloud-native way will teach you the concepts and building blocks used by all public cloud providers like AWS or GCP so that when you learn and use their specific implementations everything will make sense.</p>
<p>The goal for this guide is to make our homelab:</p>
<ul>
<li><strong>Cost-effective</strong>: We'll use a cluster of single-board computers (SBCs) for low cost and low power consumption.</li>
<li><strong>Cloud-native</strong> with these features:<ul>
<li>Scalable, highly available, virtualized workloads. </li>
<li>Block, file, and object storage. </li>
<li>Software-defined networking.</li>
</ul>
</li>
<li><strong>Open source</strong>.</li>
</ul>
<p>This project will sometimes refer to the appendix which has instructions on performing tasks used commonly in any Raspberry Pi projects, not just this one.</p>
<h2 id="background">Background<a class="headerlink" href="#background" title="Permanent link">#</a></h2>
<p>Quick overview of the technologies we'll work with. Based on  and summarized from materials compiled from different places in the Canonical documentation sites for Ubuntu, MicroCloud, MicroK8s, LXD, Ceph, and OVN.<br />
Reference: <a href="https://canonical.com">Canonical</a></p>
<h3 id="compute">Compute<a class="headerlink" href="#compute" title="Permanent link">#</a></h3>
<p>LXD is a solution for managing instances which can be virtual machines or system containers.</p>
<ul>
<li><strong>Virtual machines</strong> (VMs) have their own kernel and run on top of a hypervisor so they can run an OS different from the host. LXD uses qemu for VMs.</li>
<li><strong>System containers</strong> use the kernel on the host. They simulate a full OS and run multiple processes. Faster and more lightweight than VMs. Implemented through LXC. Not to be confused with <em>application</em> containers e.g. Docker - those are used to package a single process or application.</li>
</ul>
<h3 id="storage">Storage<a class="headerlink" href="#storage" title="Permanent link">#</a></h3>
<h4 id="storage-pools">Storage Pools<a class="headerlink" href="#storage-pools" title="Permanent link">#</a></h4>
<p>Think of them as the disks used to store data. They use one of these storage drivers:</p>
<ul>
<li>Btrfs - <code>btrfs</code></li>
<li>CephFS - <code>cephfs</code></li>
<li>Ceph Object - <code>cephobject</code></li>
<li>Ceph RBD - <code>ceph</code></li>
<li>Dell PowerFlex - <code>powerflex</code></li>
<li>Directory - <code>dir</code></li>
<li>LVM - <code>lvm</code></li>
<li>ZFS - <code>zfs</code>. Needs a GA variant of Ubuntu and <strong>not</strong> the Hardware Enablement (HWE) stack.</li>
</ul>
<div class="admonition attention">
<p class="admonition-title">Attention</p>
<p>Ubuntu <strong>Desktop</strong> installations default to tracking the <strong>HWE</strong> stack.<br />
Ubuntu <strong>Server</strong> installations default to the <strong>GA</strong> kernel with the enablement kernel as optional.</p>
</div>
<p>STORAGE LOCATION</p>
<table>
<thead>
<tr>
<th>LOCATION</th>
<th style="text-align: center;">DIRECTORY</th>
<th style="text-align: center;">BTRFS</th>
<th style="text-align: center;">LVM</th>
<th style="text-align: center;">ZFS</th>
<th style="text-align: center;">CEPH RBD</th>
<th style="text-align: center;">CEPHFS</th>
</tr>
</thead>
<tbody>
<tr>
<td>Shared with the host</td>
<td style="text-align: center;">✅</td>
<td style="text-align: center;">✅</td>
<td style="text-align: center;">➖</td>
<td style="text-align: center;">✅</td>
<td style="text-align: center;">➖</td>
<td style="text-align: center;">➖</td>
</tr>
<tr>
<td>Dedicated disk/partition</td>
<td style="text-align: center;">➖</td>
<td style="text-align: center;">✅</td>
<td style="text-align: center;">✅</td>
<td style="text-align: center;">✅</td>
<td style="text-align: center;">➖</td>
<td style="text-align: center;">➖</td>
</tr>
<tr>
<td>Loop disk</td>
<td style="text-align: center;">➖</td>
<td style="text-align: center;">✅</td>
<td style="text-align: center;">✅</td>
<td style="text-align: center;">✅</td>
<td style="text-align: center;">➖</td>
<td style="text-align: center;">➖</td>
</tr>
<tr>
<td>Remote storage</td>
<td style="text-align: center;">➖</td>
<td style="text-align: center;">➖</td>
<td style="text-align: center;">➖</td>
<td style="text-align: center;">➖</td>
<td style="text-align: center;">✅</td>
<td style="text-align: center;">✅</td>
</tr>
</tbody>
</table>
<div class="admonition hint">
<p class="admonition-title">Hint</p>
<p>The <code>ceph</code>, <code>cephfs</code>, and <code>cephobject</code> drivers store the data in an independent Ceph storage cluster that must be set up separately from LXD. This is where MicroCeph will come in.</p>
</div>
<p>FEATURE COMPARISON</p>
<table>
<thead>
<tr>
<th>FEATURE</th>
<th style="text-align: center;">DIRECTORY</th>
<th style="text-align: center;">BTRFS</th>
<th style="text-align: center;">LVM</th>
<th style="text-align: center;">ZFS</th>
<th style="text-align: center;">CEPH RBD</th>
<th style="text-align: center;">CEPHFS</th>
<th style="text-align: center;">CEPH OBJECT</th>
<th style="text-align: center;">DELL POWERFLEX</th>
</tr>
</thead>
<tbody>
<tr>
<td>Optimized image storage</td>
<td style="text-align: center;">❌</td>
<td style="text-align: center;">✅</td>
<td style="text-align: center;">✅</td>
<td style="text-align: center;">✅</td>
<td style="text-align: center;">✅</td>
<td style="text-align: center;">➖</td>
<td style="text-align: center;">➖</td>
<td style="text-align: center;">❌</td>
</tr>
<tr>
<td>Optimized instance creation</td>
<td style="text-align: center;">❌</td>
<td style="text-align: center;">✅</td>
<td style="text-align: center;">✅</td>
<td style="text-align: center;">✅</td>
<td style="text-align: center;">✅</td>
<td style="text-align: center;">➖</td>
<td style="text-align: center;">➖</td>
<td style="text-align: center;">❌</td>
</tr>
<tr>
<td>Optimized snapshot creation</td>
<td style="text-align: center;">❌</td>
<td style="text-align: center;">✅</td>
<td style="text-align: center;">✅</td>
<td style="text-align: center;">✅</td>
<td style="text-align: center;">✅</td>
<td style="text-align: center;">✅</td>
<td style="text-align: center;">➖</td>
<td style="text-align: center;">✅</td>
</tr>
<tr>
<td>Optimized image transfer</td>
<td style="text-align: center;">❌</td>
<td style="text-align: center;">✅</td>
<td style="text-align: center;">❌</td>
<td style="text-align: center;">✅</td>
<td style="text-align: center;">✅</td>
<td style="text-align: center;">➖</td>
<td style="text-align: center;">➖</td>
<td style="text-align: center;">❌</td>
</tr>
<tr>
<td>Optimized backup (import/export)</td>
<td style="text-align: center;">❌</td>
<td style="text-align: center;">✅</td>
<td style="text-align: center;">❌</td>
<td style="text-align: center;">✅</td>
<td style="text-align: center;">❌</td>
<td style="text-align: center;">➖</td>
<td style="text-align: center;">➖</td>
<td style="text-align: center;">❌</td>
</tr>
<tr>
<td>Optimized volume transfer</td>
<td style="text-align: center;">❌</td>
<td style="text-align: center;">✅</td>
<td style="text-align: center;">❌</td>
<td style="text-align: center;">✅</td>
<td style="text-align: center;">✅[1]</td>
<td style="text-align: center;">➖</td>
<td style="text-align: center;">➖</td>
<td style="text-align: center;">❌</td>
</tr>
<tr>
<td>Optimized volume refresh</td>
<td style="text-align: center;">❌</td>
<td style="text-align: center;">✅</td>
<td style="text-align: center;">✅[2]</td>
<td style="text-align: center;">✅</td>
<td style="text-align: center;">✅[3]</td>
<td style="text-align: center;">➖</td>
<td style="text-align: center;">➖</td>
<td style="text-align: center;">❌</td>
</tr>
<tr>
<td>Copy on write</td>
<td style="text-align: center;">❌</td>
<td style="text-align: center;">✅</td>
<td style="text-align: center;">✅</td>
<td style="text-align: center;">✅</td>
<td style="text-align: center;">✅</td>
<td style="text-align: center;">✅</td>
<td style="text-align: center;">➖</td>
<td style="text-align: center;">✅</td>
</tr>
<tr>
<td>Block based</td>
<td style="text-align: center;">❌</td>
<td style="text-align: center;">❌</td>
<td style="text-align: center;">✅</td>
<td style="text-align: center;">❌</td>
<td style="text-align: center;">✅</td>
<td style="text-align: center;">❌</td>
<td style="text-align: center;">➖</td>
<td style="text-align: center;">✅</td>
</tr>
<tr>
<td>Instant cloning</td>
<td style="text-align: center;">❌</td>
<td style="text-align: center;">✅</td>
<td style="text-align: center;">✅</td>
<td style="text-align: center;">✅</td>
<td style="text-align: center;">✅</td>
<td style="text-align: center;">✅</td>
<td style="text-align: center;">➖</td>
<td style="text-align: center;">❌</td>
</tr>
<tr>
<td>Storage driver usable inside a container</td>
<td style="text-align: center;">✅</td>
<td style="text-align: center;">✅</td>
<td style="text-align: center;">❌</td>
<td style="text-align: center;">✅[4]</td>
<td style="text-align: center;">❌</td>
<td style="text-align: center;">➖</td>
<td style="text-align: center;">➖</td>
<td style="text-align: center;">❌</td>
</tr>
<tr>
<td>Restore from older snapshots (not latest)</td>
<td style="text-align: center;">✅</td>
<td style="text-align: center;">✅</td>
<td style="text-align: center;">✅</td>
<td style="text-align: center;">❌</td>
<td style="text-align: center;">✅</td>
<td style="text-align: center;">✅</td>
<td style="text-align: center;">➖</td>
<td style="text-align: center;">✅</td>
</tr>
<tr>
<td>Storage quotas</td>
<td style="text-align: center;">✅[5]</td>
<td style="text-align: center;">✅</td>
<td style="text-align: center;">✅</td>
<td style="text-align: center;">✅</td>
<td style="text-align: center;">✅</td>
<td style="text-align: center;">✅</td>
<td style="text-align: center;">✅</td>
<td style="text-align: center;">✅</td>
</tr>
<tr>
<td>Available on lxd init</td>
<td style="text-align: center;">✅</td>
<td style="text-align: center;">✅</td>
<td style="text-align: center;">✅</td>
<td style="text-align: center;">✅</td>
<td style="text-align: center;">✅</td>
<td style="text-align: center;">❌</td>
<td style="text-align: center;">❌</td>
<td style="text-align: center;">❌</td>
</tr>
<tr>
<td>Object storage</td>
<td style="text-align: center;">✅</td>
<td style="text-align: center;">✅</td>
<td style="text-align: center;">✅</td>
<td style="text-align: center;">✅</td>
<td style="text-align: center;">❌</td>
<td style="text-align: center;">❌</td>
<td style="text-align: center;">✅</td>
<td style="text-align: center;">❌</td>
</tr>
</tbody>
</table>
<p>[1] Volumes of type <code>block</code> will fall back to non-optimized transfer when migrating to an older LXD server that doesn’t yet support the <code>RBD_AND_RSYNC</code> migration type.<br />
[2] Requires <code>lvm.use_thinpool</code> to be enabled. Only when refreshing local volumes.<br />
[3] Only for volumes of type <code>block</code>.<br />
[4] Requires<code>zfs.delegate</code> to be enabled.<br />
[5] The <code>dir</code> driver supports storage quotas when running on either ext4 or XFS with project quotas enabled at the file system level.  </p>
<h4 id="storage-volumes">Storage Volumes<a class="headerlink" href="#storage-volumes" title="Permanent link">#</a></h4>
<p>They're like partitions on the disk for specific purposes. Part of a storage pool. </p>
<p>Types:  </p>
<ul>
<li><code>container</code>/<code>virtual-machine</code> aka instance volumes - LXD creates these automatically when you launch an instance. Used as the root disk for the instance. Destroyed when the instance is deleted.</li>
<li><code>image</code> - Created by LXD when it unpacks an image to launch an instance from it. Deleted 10 days after it was last used to launch an instance.</li>
<li><code>custom</code> - You can add them to one or more instances as a disk device (they can be shared between instances). You can also use them as a special kind of volume to hold data separately from your instances (e.g. to hold backups or images) by setting some server configuration values. They're retained until you delete them.</li>
</ul>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>For most storage drivers, custom storage volumes are not replicated across the cluster and exist only on the member for which they were created. This is different for remote storage pools (<code>ceph</code>, <code>cephfs</code>), where volumes are available from any cluster member.</p>
</div>
<p>Storage volume <strong>content</strong> types: </p>
<ul>
<li><code>filesystem</code> - Used for <strong>containers</strong> and container images. Default for custom storage volumes. They take a mount point.</li>
<li><code>block</code> - Used for <strong>virtual machines</strong> and virtual machine images. Can be used for custom storage volumes. A custom storage volume of this content type can be attached only to virtual machines. They don't take a mount point.</li>
<li><code>iso</code> - They're always read-only and can be attached to more than one VM at a time without corrupting data.</li>
</ul>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Storage volumes of content type <code>block</code> or <code>iso</code> cannot be attached to containers, only to virtual machines.</p>
</div>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p>Custom storage volumes of content type <code>block</code> should <strong>not</strong> be shared between instances because simultaneous access can cause data corruption.</p>
</div>
<h4 id="storage-buckets">Storage Buckets<a class="headerlink" href="#storage-buckets" title="Permanent link">#</a></h4>
<ul>
<li>Object storage using the Amazon S3 protocol. Part of a pool too, just like storage volumes. </li>
<li>Assigned access keys that must be used by applications to access the bucket.</li>
</ul>
<p>Options:</p>
<ul>
<li>Local storage in a <code>dir</code>, <code>btrfs</code>, <code>lvm</code>, or <code>zfs</code> pool. Instead of adding them to an instance like a custom storage volume, they're accessed by applications directly via their URL. You must configure the S3 address for your LXD server. LXD uses MinIO for local storage buckets. </li>
<li>Remote storage ( <code>cephobject</code> pools).</li>
</ul>
<h3 id="networking">Networking<a class="headerlink" href="#networking" title="Permanent link">#</a></h3>
<h4 id="managed-networks">Managed Networks<a class="headerlink" href="#managed-networks" title="Permanent link">#</a></h4>
<h5 id="fully-controlled-networks">Fully controlled networks<a class="headerlink" href="#fully-controlled-networks" title="Permanent link">#</a></h5>
<p>They create network interfaces and provide most functionality e.g. IP management. Types:</p>
<ul>
<li>Bridge network (default) - Creates a virtual L2 ethernet switch that instance NICs can connect to. Good for  running LXD on a single system or a public cloud.</li>
<li>OVN network - Software-defined networking system for virtual network abstraction. Good for building your own private cloud. Creates a logical network. Needs the OVN tools and an uplink network (an external network or a managed LXD bridge). Can be created and managed inside a project as a non-admin user.</li>
</ul>
<h5 id="external-networks">External networks<a class="headerlink" href="#external-networks" title="Permanent link">#</a></h5>
<p>Use network interfaces that already exist. Main purpose is to provide an uplink network through a parent interface.</p>
<ul>
<li>Macvlan network - Can assign several IP addresses to the same network interface based on randomly generated MAC addresses.</li>
<li>SR-IOV network - Hardware standard that allows a single network card port to appear as several virtual network interfaces.</li>
<li>Physical network - Connects to an existing physical network (network interface or bridge).</li>
</ul>
<p>Ways to attach a network device:</p>
<ul>
<li>Default network bridge.</li>
<li>Use an existing network interface as a network device.</li>
<li>Create a managed network and attach it to the instance as a network device.</li>
</ul>
<h4 id="network-devices-nics">Network devices (NICs)<a class="headerlink" href="#network-devices-nics" title="Permanent link">#</a></h4>
<p>Network devices aka Network Interface Controllers (NICs) provide a connection to a network.</p>
<p>When you create a device you specify a device option (only 1 option):</p>
<ul>
<li><code>nictype</code> - With this option you can specify a network interface not controlled by LXD and have to specify all the info that LXD needs to use the network interface.</li>
<li><code>network</code> - When you specify this option, the NIC is linked to an existing managed network and the <code>nictype</code> option is derived automatically from the network type.</li>
</ul>
<p>NIC types that can be added using the <code>nictype</code> or <code>network</code> options:</p>
<ul>
<li><code>bridged</code> uses an existing bridge on the host.</li>
<li><code>macvlan</code> sets up a new network device based on an existing one but with a different MAC address.</li>
<li><code>sriov</code> passes a virtual function of an SR-IOV-enabled physical network device into the instance.</li>
<li><code>physical</code> Passes a physical device from the host through to the instance. The targeted device will vanish from the host and appear in the instance.</li>
</ul>
<p>NICs that can be added using the <code>network</code> option only.</p>
<ul>
<li><code>ovn</code> Uses an existing OVN network and creates a virtual device pair to connect the instance to it</li>
</ul>
<p>NICs that can be added using the <code>nictype</code> option only.</p>
<ul>
<li><code>ipvlan</code>: Sets up a new network device based on an existing one, using the same MAC address but a different IP.</li>
<li><code>p2p</code>: Creates a virtual device pair, putting one side in the instance and leaving the other side on the host.</li>
<li><code>routed</code>: Creates a virtual device pair to connect the host to the instance and sets up static routes and proxy ARP/NDP entries to allow the instance to join the network of a designated parent interface.</li>
</ul>
<h2 id="our-hardware">Our hardware<a class="headerlink" href="#our-hardware" title="Permanent link">#</a></h2>
<p><img alt="RPi" src="https://assets.raspberrypi.com/static/raspberry-pi-4-labelled@2x-1c8c2d74ade597b9c9c7e9e2fff16dd4.png" /></p>
<p>You'll need:</p>
<ul>
<li>3x Raspberry Pi 4 8GB.</li>
<li>3x 3.5A Power supply (USB-C). I recommend getting one that includes an on/off switch for convenience.</li>
<li>3x 2.5" SATA SSD.</li>
<li>3x 2.5" SATA to USB 3.0 adapter with an ASMedia chipset.</li>
<li>1x microSD card.</li>
<li>1x Cluster case with fans. Make sure it can fit 3 Pis and 3 fans.</li>
<li>3x cat5e or better ethernet cables. Optional but wired connections highly recommended.</li>
</ul>
<div class="admonition important">
<p class="admonition-title">Important</p>
<p>If using a SATA SSD make sure the cable/adapter has an <strong>ASMedia</strong> chipset so it will work properly with Raspberry Pi.</p>
</div>
<h2 id="pi-cluster-setup">Pi Cluster Setup<a class="headerlink" href="#pi-cluster-setup" title="Permanent link">#</a></h2>
<p>Follow these steps to set up your homelab. When an instruction tells you to power on the Pi you can either plug it in to power or flip the power supply switch to <em>On</em> if you have one.</p>
<ol start="0">
<li>Assemble your cluster according to your case's instructions. Plug the Raspberry Pis to your home network with the ethernet cables.</li>
<li>If you don't have an ssh key, <a href="https://www.ssh.com/academy/ssh/keygen">generate one</a> on macOS/Linux with <code>ssh-keygen -t ed25519</code>.  </li>
<li>Download the OS image with <a href="#getting-os-images">these instructions</a>.</li>
<li>Set up each of the Pis to boot from SSD.<ol>
<li>Use <a href="https://www.raspberrypi.com/software/">Raspberry Pi Imager</a> to flash the <strong>USB Boot</strong> utility image onto the microSD card. You can install it on your Mac with: 
    <div class="highlight"><pre><span></span><code>brew<span class="w"> </span>install<span class="w"> </span>--cask<span class="w"> </span>raspberry-pi-imager
</code></pre></div>
    The USB Boot utility is in Operating System &gt; CHOOSE OS &gt; Misc utility images &gt; Bootloader &gt; USB Boot.</li>
<li>Insert the card into the Pi, turn it on so the Pi flashes the bootloader from the card. When it's done the green LED will start blinking.</li>
<li>Turn off the Pi and remove the card.    </li>
</ol>
</li>
<li>For each Pi/SSD:<ol>
<li><a href="#flashing-os-images">Flash the OS image</a> to the SSD. </li>
<li>Make sure the Pi is connected to your router/switch with an ethernet cable.</li>
<li>Remove the SSD from your laptop and plug it into a USB 3.0 port on your Pi. </li>
</ol>
</li>
<li>Turn on your Pis. They have a lot of work to do on the first boot and it takes several minutes as cloud-init automatically upgrades packages, configures our systems, and installs any software we specified.<br />
    You'll be able to go in as soon as the SSH service is up but it will probably still be in the process of setting everything up.<br />
    Go make yourself a cup of tea before accessing your Pis for the first time. If you also set up the Wi-Fi connection it won't be available until everything has finished configuring and you manually do a required system restart.</li>
<li><a href="#accessing-a-pi">Connect</a> to your Pis over ssh.</li>
<li><a href="#verifying-correctness">Verify</a> everything went smoothly.</li>
</ol>
<h2 id="microcloud">MicroCloud<a class="headerlink" href="#microcloud" title="Permanent link">#</a></h2>
<p>The steps in this section can also be automated by adding them to the base cloud-init file and using <code>lxd init --preseed</code>.<br />
For now we'll go over them manually as we get more comfortable with all the moving pieces.</p>
<h3 id="install-lxd">Install LXD<a class="headerlink" href="#install-lxd" title="Permanent link">#</a></h3>
<p>For each Pi:</p>
<ol>
<li>Our cloud-init config already updated Snap for us so just make sure it's version 2.59.1 or later with <code>snap version</code>.</li>
<li>We need LXD version 5.21. Install or update with:
    <div class="highlight"><pre><span></span><code>sudo<span class="w"> </span>snap<span class="w"> </span>install<span class="w"> </span>lxd
<span class="c1"># or</span>
sudo<span class="w"> </span>snap<span class="w"> </span>refresh<span class="w"> </span>lxd<span class="w"> </span>--channel<span class="o">=</span><span class="m">5</span>.21/stable
</code></pre></div></li>
<li>Run <code>sudo lxd init</code>. Accept defaults for all questions below except the ones that have a specified value.
    <div class="highlight"><pre><span></span><code>Would you like to use LXD clustering? (yes/no) [default=no]: 
Do you want to configure a new storage pool? (yes/no) [default=yes]: 
Name of the new storage pool [default=default]: 
Name of the storage backend to use (powerflex, zfs, btrfs, ceph, dir, lvm) [default=zfs]: 
Create a new ZFS pool? (yes/no) [default=yes]: 
Would you like to use an existing empty block device (e.g. a disk or partition)? (yes/no) [default=no]: 
Size in GiB of the new loop device (1GiB minimum) [default=30GiB]: 100 # &lt;===== or whatever you want
Would you like to connect to a MAAS server? (yes/no) [default=no]: 
Would you like to create a new local network bridge? (yes/no) [default=yes]: 
What should the new bridge be called? [default=lxdbr0]: 
What IPv4 address should be used? (CIDR subnet notation, “auto” or “none”) [default=auto]: 10.1.123.1/24 # &lt;=====
Would you like LXD to NAT IPv4 traffic on your bridge? [default=yes]: 
What IPv6 address should be used? (CIDR subnet notation, “auto” or “none”) [default=auto]: fd42:1:1234:1234::1/64 # &lt;=====
Would you like LXD to NAT IPv6 traffic on your bridge? [default=yes]: 
Would you like the LXD server to be available over the network? (yes/no) [default=no]: yes # &lt;=====
Address to bind LXD to (not including port) [default=all]: 
Port to bind LXD to [default=8443]: 
Would you like stale cached images to be updated automatically? (yes/no) [default=yes]: 
Would you like a YAML &quot;lxd init&quot; preseed to be printed? (yes/no) [default=no]: 
</code></pre></div></li>
<li>Modify the default network so we can later define specific IPv6 addresses for the VMs
    <div class="highlight"><pre><span></span><code>sudo<span class="w"> </span>lxc<span class="w"> </span>network<span class="w"> </span><span class="nb">set</span><span class="w"> </span>lxdbr0<span class="w"> </span>ipv6.dhcp.stateful<span class="w"> </span><span class="nb">true</span>
</code></pre></div></li>
</ol>
<p>Note: MicroCloud requires static IPs for cluster members.</p>
<h3 id="provide-storage-disks">Provide storage disks<a class="headerlink" href="#provide-storage-disks" title="Permanent link">#</a></h3>
<p>Each Pi will have 1 VM. We'll provide each VM with 1 disk for local storage and 1 disk for remote storage. Remote storage with high availability (HA) requires at least 3 disks located across 3 cluster members.<br />
That means we'll create a total of 6 disks.</p>
<div class="highlight"><pre><span></span><code>sudo<span class="w"> </span>lxc<span class="w"> </span>storage<span class="w"> </span>list
sudo<span class="w"> </span>lxc<span class="w"> </span>storage<span class="w"> </span>show<span class="w"> </span>default<span class="w"> </span><span class="c1"># &lt;pool_name&gt;</span>
</code></pre></div>
<p>Create a ZFS storage pool called <code>disks</code>
<div class="highlight"><pre><span></span><code>sudo<span class="w"> </span>lxc<span class="w"> </span>storage<span class="w"> </span>create<span class="w"> </span>disks<span class="w"> </span>zfs<span class="w"> </span><span class="nv">size</span><span class="o">=</span>100GiB
</code></pre></div></p>
<p>Configure default volume size for the pool
<div class="highlight"><pre><span></span><code>sudo<span class="w"> </span>lxc<span class="w"> </span>storage<span class="w"> </span><span class="nb">set</span><span class="w"> </span>disks<span class="w"> </span>volume.size<span class="w"> </span>10GiB
</code></pre></div></p>
<div class="highlight"><pre><span></span><code>sudo<span class="w"> </span>lxc<span class="w"> </span>storage<span class="w"> </span>volume<span class="w"> </span>list
</code></pre></div>
<p>Create a custom volume (as opposed to an instance volume) for local storage
<div class="highlight"><pre><span></span><code>sudo<span class="w"> </span>lxc<span class="w"> </span>storage<span class="w"> </span>volume<span class="w"> </span>create<span class="w"> </span>disks<span class="w"> </span>local1<span class="w"> </span>--type<span class="w"> </span>block
</code></pre></div></p>
<p>Create volumes for remote storage
<div class="highlight"><pre><span></span><code>sudo<span class="w"> </span>lxc<span class="w"> </span>storage<span class="w"> </span>volume<span class="w"> </span>create<span class="w"> </span>disks<span class="w"> </span>remote1<span class="w"> </span>--type<span class="w"> </span>block<span class="w"> </span><span class="nv">size</span><span class="o">=</span>90GiB
</code></pre></div></p>
<p>View details
<div class="highlight"><pre><span></span><code>sudo<span class="w"> </span>lxc<span class="w"> </span>storage<span class="w"> </span>volume<span class="w"> </span>list<span class="w"> </span>disks
sudo<span class="w"> </span>lxc<span class="w"> </span>storage<span class="w"> </span>volume<span class="w"> </span>show<span class="w"> </span>disks<span class="w"> </span>custom/local1<span class="w"> </span><span class="c1"># as opposed to container/local1 or virtual-machine/local1</span>
sudo<span class="w"> </span>lxc<span class="w"> </span>storage<span class="w"> </span>volume<span class="w"> </span>show<span class="w"> </span>disks<span class="w"> </span>custom/remote1
</code></pre></div></p>
<h3 id="create-external-network">Create external network<a class="headerlink" href="#create-external-network" title="Permanent link">#</a></h3>
<p>Create a network for external connectivity
<div class="highlight"><pre><span></span><code>sudo<span class="w"> </span>lxc<span class="w"> </span>network<span class="w"> </span>create<span class="w"> </span>microbr0
</code></pre></div></p>
<p>View network details. Note down the assigned IPv4 and IPv6 addresses for the network.
<div class="highlight"><pre><span></span><code>sudo<span class="w"> </span>lxc<span class="w"> </span>network<span class="w"> </span>list

sudo<span class="w"> </span>lxc<span class="w"> </span>network<span class="w"> </span>get<span class="w"> </span>microbr0<span class="w"> </span>ipv4.address
sudo<span class="w"> </span>lxc<span class="w"> </span>network<span class="w"> </span>get<span class="w"> </span>microbr0<span class="w"> </span>ipv6.address
</code></pre></div></p>
<p>Example:
<div class="highlight"><pre><span></span><code>node-01
10.119.73.1/24
fd42:d32b:a375:2855::1/64

node-02
10.45.122.1/24
fd42:dc56:50a1:9c70::1/64

node-03
10.230.81.1/24
fd42:8cba:e02b:a498::1/64
</code></pre></div></p>
<h3 id="create-cluster-members">Create cluster members<a class="headerlink" href="#create-cluster-members" title="Permanent link">#</a></h3>
<h4 id="create-the-vms">Create the VMs<a class="headerlink" href="#create-the-vms" title="Permanent link">#</a></h4>
<p>Without starting them yet.
<div class="highlight"><span class="filename">On node-01</span><pre><span></span><code>sudo<span class="w"> </span>lxc<span class="w"> </span>init<span class="w"> </span>ubuntu:24.04<span class="w"> </span>micro1<span class="w"> </span>--vm<span class="w"> </span>--config<span class="w"> </span>limits.cpu<span class="o">=</span><span class="m">2</span><span class="w"> </span>--config<span class="w"> </span>limits.memory<span class="o">=</span>4GiB<span class="w"> </span>-d<span class="w"> </span>eth0,ipv4.address<span class="o">=</span><span class="m">10</span>.1.123.10<span class="w"> </span>-d<span class="w"> </span>eth0,ipv6.address<span class="o">=</span>fd42:1:1234:1234::10
</code></pre></div>
<div class="highlight"><span class="filename">On node-02</span><pre><span></span><code>sudo<span class="w"> </span>lxc<span class="w"> </span>init<span class="w"> </span>ubuntu:24.04<span class="w"> </span>micro2<span class="w"> </span>--vm<span class="w"> </span>--config<span class="w"> </span>limits.cpu<span class="o">=</span><span class="m">2</span><span class="w"> </span>--config<span class="w"> </span>limits.memory<span class="o">=</span>4GiB<span class="w"> </span>-d<span class="w"> </span>eth0,ipv4.address<span class="o">=</span><span class="m">10</span>.1.123.20<span class="w"> </span>-d<span class="w"> </span>eth0,ipv6.address<span class="o">=</span>fd42:1:1234:1234::20
</code></pre></div>
<div class="highlight"><span class="filename">On node-03</span><pre><span></span><code>sudo<span class="w"> </span>lxc<span class="w"> </span>init<span class="w"> </span>ubuntu:24.04<span class="w"> </span>micro3<span class="w"> </span>--vm<span class="w"> </span>--config<span class="w"> </span>limits.cpu<span class="o">=</span><span class="m">2</span><span class="w"> </span>--config<span class="w"> </span>limits.memory<span class="o">=</span>4GiB<span class="w"> </span>-d<span class="w"> </span>eth0,ipv4.address<span class="o">=</span><span class="m">10</span>.1.123.30<span class="w"> </span>-d<span class="w"> </span>eth0,ipv6.address<span class="o">=</span>fd42:1:1234:1234::30
</code></pre></div></p>
<h4 id="attach-the-disks-to-the-vms">Attach the disks to the VMs<a class="headerlink" href="#attach-the-disks-to-the-vms" title="Permanent link">#</a></h4>
<p>The storage pool (<code>disks</code>) and volumes (<code>local1</code>, <code>remote1</code>) have the same names on all machines.</p>
<div class="highlight"><span class="filename">On node-01</span><pre><span></span><code>sudo<span class="w"> </span>lxc<span class="w"> </span>storage<span class="w"> </span>volume<span class="w"> </span>attach<span class="w"> </span>disks<span class="w"> </span>local1<span class="w"> </span>micro1
sudo<span class="w"> </span>lxc<span class="w"> </span>storage<span class="w"> </span>volume<span class="w"> </span>attach<span class="w"> </span>disks<span class="w"> </span>remote1<span class="w"> </span>micro1
</code></pre></div>
<div class="highlight"><span class="filename">On node-02</span><pre><span></span><code>sudo<span class="w"> </span>lxc<span class="w"> </span>storage<span class="w"> </span>volume<span class="w"> </span>attach<span class="w"> </span>disks<span class="w"> </span>local1<span class="w"> </span>micro2
sudo<span class="w"> </span>lxc<span class="w"> </span>storage<span class="w"> </span>volume<span class="w"> </span>attach<span class="w"> </span>disks<span class="w"> </span>remote1<span class="w"> </span>micro2
</code></pre></div>
<div class="highlight"><span class="filename">On node-03</span><pre><span></span><code>sudo<span class="w"> </span>lxc<span class="w"> </span>storage<span class="w"> </span>volume<span class="w"> </span>attach<span class="w"> </span>disks<span class="w"> </span>local1<span class="w"> </span>micro3
sudo<span class="w"> </span>lxc<span class="w"> </span>storage<span class="w"> </span>volume<span class="w"> </span>attach<span class="w"> </span>disks<span class="w"> </span>remote1<span class="w"> </span>micro3
</code></pre></div>
<h4 id="add-instance-devices">Add instance devices<a class="headerlink" href="#add-instance-devices" title="Permanent link">#</a></h4>
<p>Add network interfaces that use the dedicated MicroCloud uplink network. We'll the nic <code>eth1</code>.</p>
<p>See what we have so far
<div class="highlight"><pre><span></span><code>sudo<span class="w"> </span>lxc<span class="w"> </span>config<span class="w"> </span>device<span class="w"> </span>list<span class="w"> </span>micro1<span class="w"> </span><span class="c1"># 2, 3</span>
</code></pre></div></p>
<div class="highlight"><span class="filename">On node-01</span><pre><span></span><code>sudo<span class="w"> </span>lxc<span class="w"> </span>config<span class="w"> </span>device<span class="w"> </span>add<span class="w"> </span>micro1<span class="w"> </span>eth1<span class="w"> </span>nic<span class="w"> </span><span class="nv">network</span><span class="o">=</span>microbr0<span class="w"> </span><span class="c1"># instance, device-name, type, [key=value...]</span>
</code></pre></div>
<div class="highlight"><span class="filename">On node-02</span><pre><span></span><code>sudo<span class="w"> </span>lxc<span class="w"> </span>config<span class="w"> </span>device<span class="w"> </span>add<span class="w"> </span>micro2<span class="w"> </span>eth1<span class="w"> </span>nic<span class="w"> </span><span class="nv">network</span><span class="o">=</span>microbr0
</code></pre></div>
<div class="highlight"><span class="filename">On node-03</span><pre><span></span><code>sudo<span class="w"> </span>lxc<span class="w"> </span>config<span class="w"> </span>device<span class="w"> </span>add<span class="w"> </span>micro3<span class="w"> </span>eth1<span class="w"> </span>nic<span class="w"> </span><span class="nv">network</span><span class="o">=</span>microbr0
</code></pre></div>
<h4 id="start-the-vms">Start the VMs<a class="headerlink" href="#start-the-vms" title="Permanent link">#</a></h4>
<div class="highlight"><span class="filename">On node-01</span><pre><span></span><code>sudo<span class="w"> </span>lxc<span class="w"> </span>start<span class="w"> </span>micro1
</code></pre></div>
<div class="highlight"><span class="filename">On node-02</span><pre><span></span><code>sudo<span class="w"> </span>lxc<span class="w"> </span>start<span class="w"> </span>micro2
</code></pre></div>
<div class="highlight"><span class="filename">On node-03</span><pre><span></span><code>sudo<span class="w"> </span>lxc<span class="w"> </span>start<span class="w"> </span>micro3
</code></pre></div>
<p>If a VM fails to start check if you have enough available RAM to start the VM.
<div class="highlight"><pre><span></span><code>free<span class="w"> </span>-h
<span class="c1"># Example setting a lower RAM limit on VMs</span>
sudo<span class="w"> </span>lxc<span class="w"> </span>config<span class="w"> </span><span class="nb">set</span><span class="w"> </span>micro2<span class="w"> </span>limits.memory<span class="w"> </span>2GiB
sudo<span class="w"> </span>lxc<span class="w"> </span>config<span class="w"> </span><span class="nb">set</span><span class="w"> </span>micro3<span class="w"> </span>limits.memory<span class="w"> </span>2GiB
</code></pre></div></p>
<div class="highlight"><span class="filename">On node-02</span><pre><span></span><code>
</code></pre></div>
<div class="highlight"><span class="filename">On node-03</span><pre><span></span><code>
</code></pre></div>
<h2 id="appendix">APPENDIX<a class="headerlink" href="#appendix" title="Permanent link">#</a></h2>
<h3 id="getting-os-images">Getting OS images<a class="headerlink" href="#getting-os-images" title="Permanent link">#</a></h3>
<p>We'll use an <strong>Ubuntu</strong> image made specifically for your board instead of a manufaturer's custom OS like Raspberry Pi OS. Those are designed for simplicity and ease of use at the expense of functionality that is important when building a cloud-native homelab like <a href="https://cloud-init.io"><code>cloud-init</code></a>. That's right, even our host Raspberry Pis can be set up in an automated, cloud-native way with cloud-init!</p>
<div class="admonition tip">
<p class="admonition-title">Tip</p>
<p>This lets you launch your Pi just like a cloud instance. Automatically upgrade the system, configure users, modify boot parameters, install software, run commands on first boot, among other things.</p>
</div>
<p>We'll use the <em>Server</em> version because we need a non-HWE variant for our storage pools and we don't need the graphical environment that comes with the <em>Desktop</em> version.  </p>
<p>Download the <a href="https://ubuntu.com/download/raspberry-pi">official Ubuntu image for Raspberry Pi</a> with these commands:
<div class="highlight"><span class="filename">On your laptop</span><pre><span></span><code><span class="nb">cd</span><span class="w"> </span>~/Downloads
wget<span class="w"> </span>-q<span class="w"> </span>--show-progress<span class="w"> </span>https://cdimage.ubuntu.com/releases/24.04.1/release/ubuntu-24.04.1-preinstalled-server-arm64+raspi.img.xz
</code></pre></div></p>
<p>Verify the integrity of the image file with its <a href="https://github.com/canonical/ubuntu.com/blob/main/releases.yaml">checksum</a>:
<div class="highlight"><span class="filename">On your laptop</span><pre><span></span><code><span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;e59925e211080b20f02e4504bb2c8336b122d0738668491986ee29a95610e5b1 *ubuntu-24.04.1-preinstalled-server-arm64+raspi.img.xz&quot;</span><span class="w"> </span><span class="p">|</span><span class="w"> </span>shasum<span class="w"> </span>-a<span class="w"> </span><span class="m">256</span><span class="w"> </span>--check
</code></pre></div></p>
<p>If you see an <code>OK</code> message like <code>ubuntu-24.04.1-preinstalled-server-arm64+raspi.img.xz: OK</code> go ahead and decompress the file:
<div class="highlight"><pre><span></span><code>xz<span class="w"> </span>-d<span class="w"> </span>ubuntu-24.04.1-preinstalled-server-arm64+raspi.img.xz
</code></pre></div></p>
<h3 id="flashing-os-images">Flashing OS images<a class="headerlink" href="#flashing-os-images" title="Permanent link">#</a></h3>
<p>We'll flash a pre-configured SSD with:  </p>
<ul>
<li>A hostname.</li>
<li>A user with ssh key authentication (and password authentication disabled).</li>
<li>Upgraded packages.</li>
<li>Additional packages installed.</li>
<li>Wi-Fi configuration.</li>
<li>Optional: Boot parameters modified to support application container orchestration if we ever want to use that.</li>
</ul>
<p>Execute each code block one at a time to avoid errors.</p>
<div class="admonition attention">
<p class="admonition-title">Attention</p>
<p>This guide uses macOS. If you're on something else, adjust the commands with your OS's tools to <a href="https://ostechnix.com/how-to-use-pbcopy-and-pbpaste-commands-on-linux/">copy/paste</a> and view disks, as well as its <code>dd</code> options and <a href="https://unix.stackexchange.com/questions/13711/differences-between-sed-on-mac-osx-and-other-standard-sed"><code>sed</code> version</a>.  </p>
</div>
<div class="admonition tip">
<p class="admonition-title">Tip</p>
<p>Install <code>pv</code> to see a progress bar and percentage of completion as the image is being flashed:<br />
<code>brew install pv</code></p>
</div>
<p>Connect the target device (e.g. SSD) and check the device name. 
If macOS tells you <em>The disk you attached was not readable by this computer</em> you can ignore it.
<div class="highlight"><span class="filename">On your laptop</span><pre><span></span><code>diskutil<span class="w"> </span>list
</code></pre></div></p>
<p>Wipe out any existing data/partitions.</p>
<div class="admonition danger">
<p class="admonition-title">Danger</p>
<p>Make sure you got the right device name. All data on the device will be lost.</p>
</div>
<p><div class="highlight"><span class="filename">On your laptop</span><pre><span></span><code>diskutil<span class="w"> </span>zeroDisk<span class="w"> </span>short<span class="w"> </span>/dev/disk4<span class="w"> </span><span class="c1"># or whatever name your device has</span>
</code></pre></div>
On Linux you can use <a href="https://www.gnu.org/software/parted/manual/parted.html"><code>parted</code></a>.  </p>
<p>Use that device name to flash the OS image to the card/SSD.
<div class="highlight"><span class="filename">On your laptop</span><pre><span></span><code><span class="c1">###################################################################</span>
<span class="c1"># REPLACE WITH YOUR VALUES</span>
<span class="c1">###################################################################</span>
<span class="nv">IMAGE</span><span class="o">=</span><span class="s1">&#39;ubuntu-24.04.1-preinstalled-server-arm64+raspi.img&#39;</span><span class="w"> </span>
<span class="nv">DEVICE</span><span class="o">=</span><span class="s1">&#39;/dev/disk4&#39;</span><span class="w"> </span>
<span class="c1">###################################################################</span>

<span class="c1"># Unmount the card/ssd</span>
diskutil<span class="w"> </span>unmountDisk<span class="w"> </span><span class="nv">$DEVICE</span>

<span class="nb">cd</span><span class="w"> </span>~/Downloads
<span class="c1"># sudo dd if=$IMAGE of=$DEVICE bs=1m status=progress</span>
pv<span class="w"> </span><span class="nv">$IMAGE</span><span class="w"> </span><span class="p">|</span><span class="w"> </span>sudo<span class="w"> </span>dd<span class="w"> </span><span class="nv">bs</span><span class="o">=</span>1m<span class="w"> </span><span class="nv">of</span><span class="o">=</span><span class="nv">$DEVICE</span>
</code></pre></div></p>
<p>When it's done you'll see a volume mounted on your desktop called <code>system-boot</code> or something similar.<br />
We'll modify the volume to inject the <code>user-data</code> used by cloud-init and set boot parameters to enable c-groups. On systems running k8s this is required so that kubelet will work out of the box but we'll do it here in case we want to do container orchestration directly on this system (or on system containers that share its kernel) later on.  </p>
<p>Feel free to modify in case you don't want to set up Wi-Fi or want different software installed.
<div class="highlight"><span class="filename">On your laptop</span><pre><span></span><code><span class="c1">###################################################################</span>
<span class="c1"># REPLACE WITH YOUR VALUES</span>
<span class="c1">###################################################################</span>
<span class="nv">VOLUME</span><span class="o">=</span><span class="s1">&#39;system-boot&#39;</span>

<span class="nv">HOSTNAME</span><span class="o">=</span><span class="s1">&#39;node-01&#39;</span><span class="w"> </span><span class="c1"># Change for node-02, node-03</span>
<span class="nv">LOCALE</span><span class="o">=</span><span class="s1">&#39;en_US&#39;</span><span class="w"> </span>
<span class="nv">TIMEZONE</span><span class="o">=</span><span class="s1">&#39;US/Central&#39;</span><span class="w"> </span>

<span class="nv">WIFI_NAME</span><span class="o">=</span><span class="s1">&#39;MySSID&#39;</span><span class="w"> </span>
<span class="nv">WIFI_PASSWORD</span><span class="o">=</span><span class="s1">&#39;MyPassword&#39;</span><span class="w"> </span>

pbcopy<span class="w"> </span>&lt;<span class="w"> </span>~/.ssh/id_ed25519.pub
<span class="nv">KEY</span><span class="o">=</span><span class="k">$(</span>pbpaste<span class="k">)</span>
<span class="c1">###################################################################</span>
</code></pre></div></p>
<div class="highlight"><span class="filename">On your laptop</span><pre><span></span><code><span class="c1"># create file for `cloud-init`</span>
cat<span class="w"> </span><span class="s">&lt;&lt; EOF &gt; /Volumes/$VOLUME/user-data</span>
<span class="s">#cloud-config</span>

<span class="s">hostname: ${HOSTNAME}</span>
<span class="s">manage_etc_hosts: false</span>
<span class="s">locale: ${LOCALE}</span>
<span class="s">timezone: ${TIMEZONE}</span>

<span class="s">users:</span>
<span class="s">  - name: pi</span>
<span class="s">    shell: /bin/bash</span>
<span class="s">    lock_passwd: true</span>
<span class="s">    sudo: ALL=(ALL) NOPASSWD:ALL</span>
<span class="s">    ssh_authorized_keys:</span>
<span class="s">      - ${KEY}</span>

<span class="s">package_upgrade: true</span>
<span class="s">packages:</span>
<span class="s">  # For detailed hardware info</span>
<span class="s">  - lshw</span>
<span class="s">  # Networking tools like ifconfig</span>
<span class="s">  #- net-tools</span>
<span class="s">  # Kernel modules needed by storage solutions like OpenEBS or Rook Ceph</span>
<span class="s">  - linux-modules-extra-$(uname -r)</span>
<span class="s">  # For managing logical partitions</span>
<span class="s">  - lvm2</span>

<span class="s">write_files:</span>
<span class="s">- content: |</span>
<span class="s">    # This file is generated from information provided by the datasource.  Changes</span>
<span class="s">    # to it will not persist across an instance reboot.  To disable cloud-init&#39;s</span>
<span class="s">    # network configuration capabilities, write a file</span>
<span class="s">    # /etc/cloud/cloud.cfg.d/99-disable-network-config.cfg with the following:</span>
<span class="s">    # network: {config: disabled}</span>
<span class="s">    network:</span>
<span class="s">        ethernets:</span>
<span class="s">            eth0:</span>
<span class="s">                dhcp4: true</span>
<span class="s">                optional: true</span>
<span class="s">        version: 2</span>
<span class="s">        wifis:</span>
<span class="s">            wlan0:</span>
<span class="s">                optional: true</span>
<span class="s">                access-points:</span>
<span class="s">                    &quot;${WIFI_NAME}&quot;:</span>
<span class="s">                        password: &quot;${WIFI_PASSWORD}&quot;</span>
<span class="s">                dhcp4: true</span>
<span class="s">  path: /etc/netplan/50-cloud-init.yaml</span>
<span class="s">- content: |</span>
<span class="s">    network: {config: disabled}</span>
<span class="s">  path: /etc/cloud/cloud.cfg.d/99-disable-network-config.cfg</span>

<span class="s">runcmd:</span>
<span class="s">  #- sudo ifconfig wlan0 up</span>
<span class="s">  - sudo snap refresh</span>
<span class="s">  # For MicroK8s</span>
<span class="s">  #- sudo snap install microk8s --channel=1.28/stable --classic</span>
<span class="s">  #- sudo usermod -a -G microk8s pi</span>
<span class="s">  #- sudo chown -f -R pi ~/.kube</span>
<span class="s">  #- newgrp microk8s</span>
<span class="s">  # For OpenEBS</span>
<span class="s">  #- sudo sysctl vm.nr_hugepages=1024</span>
<span class="s">  #- echo &#39;vm.nr_hugepages=1024&#39; | sudo tee -a /etc/sysctl.conf</span>
<span class="s">  #- sudo modprobe nvme_tcp</span>
<span class="s">  #- echo &#39;nvme-tcp&#39; | sudo tee -a /etc/modules-load.d/microk8s-mayastor.conf</span>
<span class="s">  # For Ceph</span>
<span class="s">  - sudo modprobe rbd</span>
<span class="s">  - echo &#39;rbd&#39; | sudo tee -a /etc/modules-load.d/modules.conf</span>
<span class="s">  # For full-disk encryption</span>
<span class="s">  - sudo modprobe dm-crypt</span>
<span class="s">  - echo &#39;dm-crypt&#39; | sudo tee -a /etc/modules-load.d/modules.conf</span>
<span class="s">EOF</span>

<span class="c1"># For Kubernetes to run on the Pi, add these options at the end of the file.</span>
sed<span class="w"> </span>-i<span class="w"> </span><span class="s2">&quot;&quot;</span><span class="w"> </span><span class="s2">&quot;</span>$<span class="s2"> s/</span>$<span class="s2">/ cgroup_enable=memory cgroup_memory=1/&quot;</span><span class="w"> </span>/Volumes/<span class="nv">$VOLUME</span>/cmdline.txt
</code></pre></div>
<p>You can verify that the files were written correctly
<div class="highlight"><span class="filename">On your laptop</span><pre><span></span><code>cat<span class="w"> </span>/Volumes/<span class="nv">$VOLUME</span>/user-data
</code></pre></div>
<div class="highlight"><span class="filename">On your laptop</span><pre><span></span><code>cat<span class="w"> </span>/Volumes/<span class="nv">$VOLUME</span>/cmdline.txt
</code></pre></div></p>
<p>Unmount the card/SSD
<div class="highlight"><span class="filename">On your laptop</span><pre><span></span><code>diskutil<span class="w"> </span>unmountDisk<span class="w"> </span><span class="nv">$DEVICE</span>
</code></pre></div></p>
<p>🎉 <strong>You're done!</strong> 🍾  </p>
<p>Head back to the <a href="#pi-cluster-setup">Pi Cluster Setup</a> section for the next steps.</p>
<h3 id="accessing-a-pi">Accessing a Pi<a class="headerlink" href="#accessing-a-pi" title="Permanent link">#</a></h3>
<div class="admonition tip">
<p class="admonition-title">Tip</p>
<p><strong>Before connecting to your Pi</strong><br />
If it's not already running, start the <code>ssh-agent</code> in the background and add your private key to it so you're not asked for your passphrase every time.
<div class="highlight"><span class="filename">On your laptop</span><pre><span></span><code><span class="c1"># is it running?</span>
ps<span class="w"> </span>-ax<span class="w"> </span><span class="p">|</span><span class="w"> </span>grep<span class="w"> </span>ssh-agent
<span class="c1"># which identities have been added?</span>
ssh-add<span class="w"> </span>-l

<span class="c1"># start the agent and add your identity</span>
<span class="nb">eval</span><span class="w"> </span><span class="s2">&quot;</span><span class="k">$(</span>ssh-agent<span class="w"> </span>-s<span class="k">)</span><span class="s2">&quot;</span>
ssh-add<span class="w"> </span>--apple-use-keychain<span class="w"> </span>~/.ssh/id_ed25519
</code></pre></div></p>
</div>
<div class="admonition attention">
<p class="admonition-title">Attention</p>
<p>If you're <strong>reinstalling</strong> the OS you might need to remove old key fingerprints belonging to that hostname from your <code>known_hosts</code> file.<br />
Examples:
<div class="highlight"><span class="filename">On your laptop</span><pre><span></span><code>ssh-keygen<span class="w">  </span>-f<span class="w"> </span>~/.ssh/known_hosts<span class="w"> </span>-R<span class="w"> </span><span class="m">192</span>.168.xxx.xxx
ssh-keygen<span class="w">  </span>-f<span class="w"> </span>~/.ssh/known_hosts<span class="w"> </span>-R<span class="w"> </span>node-01
ssh-keygen<span class="w">  </span>-f<span class="w"> </span>~/.ssh/known_hosts<span class="w"> </span>-R<span class="w"> </span>raspberrypi4b.local
</code></pre></div></p>
</div>
<p>SSH into it with the configured user e.g. <code>pi</code> and hostname or IP address.<br />
The first time you access it you'll get asked about adding the key fingerprint to the list of known hosts. Choose <code>yes</code>.
<div class="highlight"><span class="filename">On your laptop</span><pre><span></span><code>ssh<span class="w"> </span>pi@node-01<span class="w"> </span><span class="c1"># hostname or IP address</span>
</code></pre></div></p>
<div class="admonition attention">
<p class="admonition-title">Attention</p>
<p>If you're on a VPN you may need to disconnect from it to access your Pis using the hostname.</p>
</div>
<p>If you want to use the IP address, find your board's IP in your router's admin UI or by going over the list of all devices on your network with <code>arp -a</code>.</p>
<p>If you see a welcome message with <code>System restart required</code>, <code>sudo reboot</code> and ssh again.</p>
<h3 id="verifying-correctness">Verifying correctness<a class="headerlink" href="#verifying-correctness" title="Permanent link">#</a></h3>
<p>Once cloud-init is done launching our instance, check a few things to make sure everything went smoothly.</p>
<p>Access your pi via ssh as explained <a href="#accessing-a-pi">here</a>.</p>
<div class="highlight"><span class="filename">On your Pi</span><pre><span></span><code><span class="c1"># Verify your kernel is built with the modules you need for Ceph RBD (RADOS Block Device) and for disk encryption. </span>
<span class="c1"># It&#39;s OK if they&#39;re not currently being used (a zero in the third column of the results). They just need to be loaded.</span>
lsmod<span class="w"> </span><span class="p">|</span><span class="w"> </span>grep<span class="w"> </span>-iE<span class="w"> </span><span class="s1">&#39;crypto|dm_crypt|aes&#39;</span><span class="w"> </span><span class="c1"># verify that at least dm_crypt is available.</span>
lsmod<span class="w"> </span><span class="p">|</span><span class="w"> </span>grep<span class="w"> </span>-iE<span class="w"> </span><span class="s1">&#39;rbd|ceph&#39;</span><span class="w"> </span><span class="c1"># verify that at least rbd is available.</span>

<span class="c1"># You can also check with</span>
sudo<span class="w"> </span>modinfo<span class="w"> </span>dm-crypt
sudo<span class="w"> </span>modinfo<span class="w"> </span>rbd

<span class="c1"># if they&#39;re not found:</span>
sudo<span class="w"> </span>modprobe<span class="w"> </span>dm-crypt
sudo<span class="w"> </span>modprobe<span class="w"> </span>rbd

<span class="c1"># Check if the unattended upgrade service is running</span>
systemctl<span class="w"> </span>status<span class="w"> </span>unattended-upgrades.service

<span class="c1"># Check cloud-init&#39;s network configuration </span>
cat<span class="w"> </span>/etc/netplan/50-cloud-init.yaml
cat<span class="w"> </span>/etc/cloud/cloud.cfg.d/99-disable-network-config.cfg

<span class="c1"># Look at the state of the network.</span>
<span class="c1"># You may need to `sudo reboot` for Wi-Fi to be enabled but </span>
<span class="c1"># make sure you&#39;ve allowed enough time for cloud-init to </span>
<span class="c1"># finish configuring your instance.</span>
sudo<span class="w"> </span>lshw<span class="w"> </span>-c<span class="w"> </span>network
ip<span class="w"> </span>addr<span class="w"> </span>show<span class="w"> </span><span class="p">|</span><span class="w"> </span>grep<span class="w"> </span>wlan0
</code></pre></div>
<h2 id="troubleshooting">Troubleshooting<a class="headerlink" href="#troubleshooting" title="Permanent link">#</a></h2>
<ul>
<li>I see <code>cloud-init</code> had failures.<br />
    Based on the <code>user-data</code> file:
    Manually run <code>sudo apt update</code>, <code>sudo apt full-upgrade</code>.<br />
    Manually run <code>sudo apt install</code> on any packages that failed.<br />
    Manually add any kernel modules you need and make sure <code>/etc/modules-load.d/modules.conf</code> has them so they'll be added on every boot.</li>
<li>I'm not sure cgroups are enabled.<br />
    Check with 
    <div class="highlight"><pre><span></span><code>cat<span class="w"> </span>/proc/cgroups
</code></pre></div></li>
</ul>





                
              </article>
            </div>
          
          
        </div>
        
          <button type="button" class="md-top md-icon" data-md-component="top" hidden>
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8v12Z"/></svg>
  Back to top
</button>
        
      </main>
      
        <footer class="md-footer">
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    
    <script id="__config" type="application/json">{"base": "..", "features": ["navigation.expand", "navigation.top", "content.code.copy"], "search": "../assets/javascripts/workers/search.f886a092.min.js", "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}}</script>
    
    
      <script src="../assets/javascripts/bundle.cd18aaf1.min.js"></script>
      
        <script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.0/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
      
    
  </body>
</html>